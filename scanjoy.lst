
; ******** Source: scanjoy.asm
     1                          ; scanjoy.asm - Commodore 64 joystick / keyboard scans addressing interference
     2                          ; Copyright (c) 2024 by David Van Wagner ALL RIGHTS RESERVED
     3                          ; MIT LICENSE
     4                          ; github.com/davervw
     5                          ; www.davevw.com
     6                          
     7                          scan=$cb     ; last keyboard scan 0..64, 64=none
     8                          shflag=$28d  ; shift(1)/commodore(2)/control(4) flags
     9                          CIAPRA=$dc00 ; CIA#1 Data Port Register A
    10                          CIAPRB=$dc01 ; CIA#1 Data Port Register B
    11                          kbdmatrix=$eb81
    12                          CHROUT=$ffd2 ; KERNAL character out
    13                          joy1 = $fd
    14                          joy2 = $fe
    15                          oldirq = $ea31
    16                          oldkeylog = $eb48
    17                          irqvector = $314
    18                          keylogvector = $28f
    19                          
    20                          *=$c000
    21  c000 4c06c0             	jmp init
    22  c003 4c24c0             	jmp doscan
    23                          
    24                          init:
    25  c006 a9dd               	lda #<title
    26  c008 a2c0               	ldx #>title
    27  c00a 20a1c0             	jsr strout
    28  c00d 78                 	sei
    29  c00e a9b2               	lda #<newirq
    30  c010 a2c0               	ldx #>newirq
    31  c012 8d1403             	sta irqvector
    32  c015 8e1503             	stx irqvector+1
    33  c018 a9d7               	lda #<newkeylog
    34  c01a a2c0               	ldx #>newkeylog
    35  c01c 8d8f02             	sta keylogvector
    36  c01f 8e9002             	stx keylogvector+1
    37  c022 58                 	cli
    38  c023 60                 	rts
    39                          
    40                          doscan:
    41  c024 08                 	php
    42  c025 78                 	sei
    43                          repeatscan:	
    44  c026 a940               	lda #64
    45  c028 85cb               	sta scan
    46  c02a a900               	lda #0
    47  c02c 8d8d02             	sta shflag
    48  c02f 8d00dc             	sta CIAPRA
    49  c032 ad01dc             -   lda CIAPRB
    50  c035 cd01dc                 cmp CIAPRB
    51  c038 d0f8               	bne -
    52  c03a c9ff               	cmp #$ff
    53  c03c f055               	beq exitscan
    54  c03e a000               	ldy #0
    55  c040 a2fe               	ldx #$fe
    56                          scancol:
    57  c042 8e00dc             	stx CIAPRA
    58  c045 ad01dc             -   lda CIAPRB
    59  c048 cd01dc                 cmp CIAPRB
    60  c04b d0f8               	bne -
    61  c04d 05fd               	ora joy1
    62  c04f c9ff               	cmp #$ff
    63  c051 f022               	beq notrow
    64                          nextcol:
    65  c053 4a                 	lsr
    66  c054 48                 	pha
    67  c055 b011               	bcs +
    68  c057 b981eb             	lda kbdmatrix,y
    69  c05a c905               	cmp #5
    70  c05c b008               	bcs notshift
    71  c05e 0d8d02             	ora shflag
    72  c061 8d8d02             	sta shflag
    73  c064 d002               	bne +
    74                          notshift:
    75  c066 84cb               	sty scan
    76  c068 c8                 +	iny
    77  c069 98                 	tya
    78  c06a 2907               	and #7
    79  c06c 18                 	clc
    80  c06d d001               	bne +
    81  c06f 38                 	sec
    82  c070 68                 +	pla
    83  c071 b007               	bcs +
    84  c073 90de               	bcc nextcol
    85                          notrow:	
    86  c075 98                 	tya
    87  c076 18                 	clc
    88  c077 6908               	adc #8
    89  c079 a8                 	tay
    90  c07a 8a                 +	txa
    91  c07b 38                 	sec
    92  c07c 2a                 	rol
    93  c07d aa                 	tax
    94  c07e b0c2               	bcs scancol
    95  c080 a9ff               	lda #$ff
    96  c082 8d00dc             	sta CIAPRA
    97  c085 ad01dc             -	lda CIAPRB
    98  c088 cd01dc             	cmp CIAPRB
    99  c08b d0f8               	bne -
   100  c08d 49ff               	eor #$ff
   101  c08f c5fd               	cmp joy1
   102  c091 d093               	bne repeatscan
   103                          exitscan:
   104  c093 a97f               	lda #$7f
   105  c095 8d00dc             	sta CIAPRA
   106  c098 a5cb               	lda scan
   107  c09a ae8d02             	ldx shflag
   108  c09d a000               	ldy #0
   109  c09f 28                 	plp
   110  c0a0 60                 	rts
   111                          
   112                          strout:
   113  c0a1 85fb               	sta $fb
   114  c0a3 86fc               	stx $fc
   115  c0a5 a000               	ldy #0
   116  c0a7 b1fb               -	lda ($fb),y
   117  c0a9 f006               	beq +
   118  c0ab 20d2ff             	jsr CHROUT
   119  c0ae c8                 	iny
   120  c0af d0f6               	bne -
   121  c0b1 60                 +	rts
   122                          
   123                          newirq:
   124  c0b2 a9ff               	lda #$ff
   125  c0b4 8d00dc             	sta CIAPRA
   126  c0b7 ad01dc             -   lda CIAPRB
   127  c0ba cd01dc                 cmp CIAPRB
   128  c0bd d0f8               	bne -
   129  c0bf 49ff               	eor #$ff
   130  c0c1 85fd               	sta joy1
   131  c0c3 ad00dc             -   lda CIAPRA
   132  c0c6 cd00dc                 cmp CIAPRA
   133  c0c9 d0f8               	bne -
   134  c0cb 49ff               	eor #$ff
   135  c0cd 85fe               	sta joy2
   136  c0cf a97f               	lda #$7f
   137  c0d1 8d00dc             	sta CIAPRA
   138  c0d4 4c31ea             	jmp oldirq
   139                          
   140                          newkeylog:
   141  c0d7 2024c0             	jsr doscan
   142  c0da 4c48eb             	jmp oldkeylog
   143                          
   144                          title: 
   145  c0dd 93                 	!byte 147
   146  c0de 125343414e4a4f59...	!text 18,"SCANJOY (C) 2024     GITHUB.COM/DAVERVW"
   147  c106 9d9d9d9d9d9d9d9d...	!text 157,157,157,157,157,157,157,157,157,157,157,157,157,157,157,157,157,157,148,32,13
   148  c11b 1242592044415649...	!text 18,"BY DAVID R. VAN WAGNER       DAVEVW.COM"
   149  c143 9d9d9d9d9d9d9d9d...	!text 157,157,157,157,157,157,157,157,157,157,148,32,13
